---
- hosts: all
  gather_facts: no
  tasks:
    - name: "Download Zabbix repository package"
      get_url:
        url: "http://repo.zabbix.com/zabbix/3.0/ubuntu/pool/main/z/zabbix-release/zabbix-release_3.0-1+trusty_all.deb"
        dest: "/tmp/zabbix-release_3.0-1+trusty_all.deb"

    - name: "Install Zabbix repository"
      apt:
        deb: "/tmp/zabbix-release_3.0-1+trusty_all.deb"

    - name: "Update apt package index"
      apt:
        update_cache: yes

    - name: "Install Zabbix packages"
      apt:
        name: "{{ item }}"
        state: "latest"
      with_items:
        - zabbix-server-mysql
        - zabbix-frontend-php
        - python-mysqldb

    - name: "Configure Zabbix"
      copy:
        dest: "/etc/zabbix/web/zabbix.conf.php"
        src: "zabbix.conf.php"
        owner: "root"
        group: "root"
        mode: "0644"

    - name: "Create Zabbix database"
      mysql_db:
        name: "zabbix"
        login_user: "root"
        state: "present"

    - name: "Create the zabbix user in the zabbix database"
      mysql_user:
        name: "zabbix"
        password: ""
        priv: "zabbix.*:ALL"
        login_user: "root"
        state: "present"

    - name: "Upload initial schema and data"
      copy:
        dest: "/tmp/bootstrap-zabbix.sql"
        src: "bootstrap-zabbix.sql"
        owner: "root"
        group: "root"
        mode: "0644"

    - name: "Import initial schema and data"
      shell: "cat /tmp/bootstrap-zabbix.sql | sed 's/__site_name__/{{ site_name }}/g' | mysql -uroot zabbix"

    - name: "Set Zabbix timezone"
      lineinfile:
        name: "/etc/zabbix/apache.conf"
        line: "        php_value date.timezone UTC"
        regexp: "php_value date.timezone"
        backrefs: yes
        state: "present"

    - name: "Restart apache"
      service:
        name: "apache2"
        state: "restarted"

    - name: "Restart apache"
      service:
        name: "zabbix-server"
        state: "restarted"
