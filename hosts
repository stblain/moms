#! /usr/bin/env python

# Standard library imports
import json
import sys

# Related third party imports
import requests

# Constants
ZABBIX_URL = "http://192.0.2.202/zabbix/api_jsonrpc.php"
ZABBIX_ROLE_PATTERN = "Role - "
ZABBIX_SITE_PATTERN = "Site - "


def macro_to_var(macro):
    var_name = macro['macro'].strip("{$}").lower()

    return (var_name, macro['value'])


def do_list():
    inventory = {}

    # Get the groups for each type
    for pattern in [ZABBIX_ROLE_PATTERN, ZABBIX_SITE_PATTERN]:
        zabbix_response = requests.post(ZABBIX_URL, json={'jsonrpc': "2.0",
                                                          'method': "hostgroup.get",
                                                          'params': {'output': ["name"],
                                                                     'search': {"name": pattern},
                                                                     'startSearch': True,
                                                                     'selectHosts': ['name', 'hostid'],
                                                                     },
                                                          'id': 0,
                                                          'auth': zabbix_auth_token,
                                                          },
                                        )

        # Populate every retrieved group
        for group in zabbix_response.json()['result']:
            group_name = group['name'].replace(pattern, "")
            ansible_group = {}

            # Populate the hostnames
            ansible_group['hosts'] = map(lambda x: x['name'], group['hosts'])

            # Populate the variables
            ansible_group['vars'] = {} if pattern != ZABBIX_SITE_PATTERN else {'site_name': group_name}
            zabbix_response = requests.post(ZABBIX_URL, json={'jsonrpc': "2.0",
                                                              'method': "template.get",
                                                              'params': {'output': ["name"],
                                                                         'search': {'name': "Configuration " + group['name']},
                                                                         'selectMacros': ["macro", "value"],
                                                                         },
                                                              'id': 0,
                                                              'auth': zabbix_auth_token,
                                                              },
                                            )
            result_json = zabbix_response.json()['result']
            ansible_group['vars'].update(map(macro_to_var, result_json[0]['macros']))

            # Add the group to the inventory
            inventory[group_name] = ansible_group

    # Populate the variables of the all group
    inventory['all'] = {'vars': {}}
    zabbix_response = requests.post(ZABBIX_URL, json={'jsonrpc': "2.0",
                                                          'method': "usermacro.get",
                                                          'params': {'output': ["macro", "value"],
                                                                     'globalmacro': True,
                                                                     },
                                                          'id': 0,
                                                          'auth': zabbix_auth_token,
                                                          },
                                    )
    result_json = zabbix_response.json()['result']
    inventory['all']['vars'].update(map(macro_to_var, result_json))

    # Print the inventory
    print json.dumps(inventory, indent=4)


def do_host(host):
    variables = {}

    # Retrieve the host info
    zabbix_response = requests.post(ZABBIX_URL, json={'jsonrpc': "2.0",
                                                          'method': "host.get",
                                                          'params': {'output': ["hostid"],
                                                                     'search': {"name": host},
                                                                     'startSearch': True,
                                                                     'selectMacros': ["macro", "value"],
                                                                     'selectInterfaces': ["ip"],
                                                                     },
                                                          'id': 0,
                                                          'auth': zabbix_auth_token,
                                                          },
                                        )
    result_json = zabbix_response.json()['result']
    variables['ansible_host'] = result_json[0]['interfaces'][0]['ip']
    variables.update(map(macro_to_var, zabbix_response.json()['result'][0]['macros']))

    # Print the variables
    print json.dumps(variables, indent=4)

# Get the authentification token
zabbix_response = requests.post(ZABBIX_URL, json={"jsonrpc": "2.0",
                                                  "method": "user.login",
                                                  "params": {"user": "Admin",
                                                             "password": "zabbix",
                                                             },
                                                  "id": 1,
                                                  },
                                )
zabbix_auth_token = zabbix_response.json()['result']

if sys.argv[1] == "--list":
    do_list()
elif sys.argv[1] == "--host":
    do_host(sys.argv[2])
